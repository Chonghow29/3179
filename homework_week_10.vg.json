{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "title": {
    "text": "Global Water Stress (2024)",
    "fontSize": 18,
    "anchor": "middle",
    "color": "black"
  },
  "params": [
    {
      "name": "minScore",
      "value": 2.5,
      "bind": {
        "input": "range",
        "min": 0,
        "max": 5,
        "step": 0.1,
        "name": "Minimum Water Stress Score: "
      }
    }
  ],
  "vconcat": [
    {
      "width": 1200,
      "height": 500,
      "title": {
        "text": "Categorized Water Stress Rankings by Country (Low to Extremely High)",
        "subtitleFontSize": 14
      },
      "projection": {"type": "equalEarth"},
      "data": {
        "url": "data/ne_110m.json",
        "format": {"type": "topojson", "feature": "ne_110m_admin_0_countries"}
      },
      "transform": [
        {
          "lookup": "properties.NAME",
          "from": {
            "data": {
              "url": "data/country_water_stress_ranking.csv"
            },
            "key": "name_0",
            "fields": ["cat", "score", "indicator_name", "un_region", "wb_region"]
          }
        },
        {
          "calculate": "datum.cat === '0' ? 'Low' : datum.cat === '1' ? 'Low-Medium' : datum.cat === '2' ? 'Medium-High' : datum.cat === '3' ? 'High' : datum.cat === '4' ? 'Extremely High' : 'No Data'",
          "as": "category"
        }
      ],
      "mark": {"type": "geoshape"},
      "encoding": {
        "color": {
          "field": "category",
          "type": "ordinal",
          "scale": {
            "domain": ["No Data", "Low", "Low-Medium", "Medium-High", "High", "Extremely High"],
            "range": ["lightgray", "#ccece6", "#99d8c9", "#66c2a4", "#41ae76", "#238b45"]
          },
          "legend": {
            "title": "Water Stress Levels (2024)",
            "orient": "right",
            "labelFontSize": 11,
            "titleFontSize": 13,
            "fillColor": null
          }
        },
        "tooltip": [
          {"field": "properties.NAME", "title": "Country", "type": "nominal"},
          {"field": "category", "title": "Water Stress Category", "type": "ordinal"},
          {"field": "score", "title": "Water Stress Score (0-5)", "type": "quantitative"},
          {"field": "indicator_name", "title": "Water Stress Indicator", "type": "nominal"},
          {"field": "un_region", "title": "UN Region", "type": "nominal"},
          {"field": "wb_region", "title": "World Bank Region", "type": "nominal"}
        ]
      }
    },
    {
      "width": 1200,
      "height": 500,
      "data": {
        "url": "data/country_water_stress_ranking.csv"
      },
      "transform": [
        {
          "aggregate": [
            {
              "op": "mean",
              "field": "score",
              "as": "avg_score"
            }
          ],
          "groupby": ["name_0"]
        },
        {
          "filter": "datum.avg_score > minScore"
        },
        {
          "calculate": "datum.avg_score === 0 ? 'Low' : datum.avg_score < 1 ? 'Low' : datum.avg_score < 2 ? 'Low-Medium' : datum.avg_score < 3 ? 'Medium-High' : datum.avg_score < 4 ? 'High' : 'Extremely High'",
          "as": "category"
        },
        {
          "window": [{"op": "rank", "as": "ranking"}],
          "sort": [{"field": "avg_score", "order": "descending"}]
        }
      ],
      "layer": [
        {
          "mark": "bar",
          "encoding": {
            "x": {
              "field": "name_0",
              "type": "nominal",
              "title": "Country",
              "sort": {
                "op": "mean",
                "field": "avg_score",
                "order": "descending"
              }
            },
            "y": {
              "field": "avg_score",
              "type": "quantitative",
              "title": "Average Water Stress Score"
            },
            "color": {
              "field": "category",
              "type": "nominal",
              "scale": {
                "domain": ["Low", "Low-Medium", "Medium-High", "High", "Extremely High"],
                "range": ["#99ffcc", "#66e6b3", "#33cc99", "#1ab399", "#009966"]
              },
              "legend": {
                "title": "Water Stress Category"
              }
            },
            "tooltip": [
              {
                "field": "name_0",
                "title": "Country"
              },
              {
                "field": "avg_score",
                "type": "quantitative",
                "title": "Average Water Stress Score"
              }
            ]
          }
        },
        {
          "mark": {
            "type": "text",
            "align": "right",
            "dx": -8,
            "dy": -8,
            "baseline": "middle",
            "fontStyle": "italic"
          },
          "transform": [
            {
              "filter": "datum.avg_score > 4"   
            },
            {
              "calculate": "'Highest Water Stress: ' + datum.name_0 + ' (Avg Score: ' + datum.avg_score + ')' ",
              "as": "text_annotation"
            }
          ],
          "encoding": {
            "x": {"field": "name_0", "type": "nominal"},
            "y": {"field": "avg_score", "type": "quantitative"},
            "text": {"field": "text_annotation"}
          }
        }
      ]
    }
  ]
}